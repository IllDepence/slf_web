<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hello Bulma!</title>
    <link rel="stylesheet" href="css/bulma.min.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"> -->
  </head>
  <body>

  <nav class="navbar is-light" role="navigation" aria-label="main navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="index.html">
          <p><strong>[ SLF ]</strong></p>
        </a>

        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="navbarBasicExample" class="navbar-menu">
        <div class="navbar-start">
          <a class="navbar-item">Home</a>
          <a class="navbar-item">Documentation</a>

          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link">More</a>

            <div class="navbar-dropdown">
              <a class="navbar-item">About</a>
              <a class="navbar-item">Jobs</a>
              <a class="navbar-item">Contact</a>
              <hr class="navbar-divider">
              <a class="navbar-item">Report an issue</a>
            </div>
          </div>
        </div>

        <div class="navbar-end">
          <div class="navbar-item">
            <a><strong>GitHub</strong></a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- # # # # # # # # # # # # # # # # # # # # # # # # # # # -->

  <section class="section">
    <div class="table-container">
      <table class="table is-fullwidth" id="gameAnswerTable">
        <thead>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
    <div class="table-container">
      <table class="table is-fullwidth" id="gameInputTable">
        <tbody>
        </tbody>
      </table>
    </div>
  </section>

  <section>
    <hr class="hr">
    <div class="level" id="playerList">
    </div>
  </section>

  <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
  <script>
  // Get parameters from URL
  const urlParams = new URLSearchParams(window.location.search);
  const playerName = urlParams.get('playerName');
  const playerColor = urlParams.get('playerColor');
  const serverId = urlParams.get('serverId');
  const serverPw = urlParams.get('serverPw');

  // Fill game table
  function fillGameTable(column_names) {
    // append points column
    column_names.push('P');
    // create answer table header
    var answerTable = document.getElementById('gameAnswerTable');
    var thead = answerTable.getElementsByTagName('thead')[0];
    var row = thead.insertRow();
    for (var i = 0; i < column_names.length; i++) {
      var th = document.createElement('th');
      th.innerHTML = column_names[i];
      row.appendChild(th);
    }
    // create input table body
    var inputTable = document.getElementById('gameInputTable');
    var tbody = inputTable.getElementsByTagName('tbody')[0];
    var row = tbody.insertRow();
    for (var i = 0; i < column_names.length; i++) {
      var cell = row.insertCell();
      // put text fields inside table cells
      var input = document.createElement('input');
      input.type = 'text';
      // if it's the rightmost column, make it a number field
      if (i == column_names.length - 1) {
        input.type = 'number';
        input.classList.add('answer_points');
      }
      input.id = `answer_input_${i}`;
      // add event listener to input
      // answer cells:
      // when the field is non empty and the user presses enter,
      // make the field uneditable and focus on the next field
      // points cell:
      // when the field is non empty and the user presses enter,
      // put all the values of the input table into the answer table
      // and clear the input table
      input.addEventListener('keyup', function(event) {
        if (event.keyCode === 13) {
          var input = event.target;
          var value = input.value;
          if (value == '') {
            // if the field is empty, stop
            return;
          }
          // if it's the points field
            if (input.classList.contains('answer_points')) {
            // add a new answer row to fill
            addAnswerRow();
            // get the last row of the answer table
            var answerTable = document.getElementById('gameAnswerTable');
            var tbody = answerTable.getElementsByTagName('tbody')[0];
            var rowToFill = tbody.lastChild;
            var numCols = rowToFill.getElementsByTagName('td').length;
            for (var i = 0; i < numCols; i++) {
              // get the value of the corresponding input field
              var input = document.getElementById(`answer_input_${i}`);
              var value = input.value;
              // put the value in the answer table
              var cell = rowToFill.getElementsByClassName(`answer_${i}`)[0];
              cell.innerHTML = value;
              // clear the input field and make it editable
              input.value = '';
              input.disabled = false;
            }
          }
          // ----
        }
      });
      input.classList.add('input');
      cell.appendChild(input);
    }
  }

  // Function for adding a new row to the answers table
  // each table cell gets an id of the form 'answer_<col>'
  function addAnswerRow() {
    var answerTable = document.getElementById('gameAnswerTable');
    var thead = answerTable.getElementsByTagName('thead')[0];
    var numCols = thead.getElementsByTagName('th').length;
    console.log(numCols);
    var tbody = answerTable.getElementsByTagName('tbody')[0];
    var row = tbody.insertRow();
    for (var i = 0; i < numCols; i++) {
      var cell = row.insertCell();
      cell.classList.add(`answer_${i}`);
      cell.innerHTML = '';
    }
  }

  // Update player list
  function updatePlayerList(playerList) {
    console.log('updating player list');
    var playerListFooter = document.getElementById('playerList');
    playerListFooter.innerHTML = '';
    playerList.forEach(player => {
      console.log(player);
      // skip if player is ourselves
      if (player.id == window.playerId) {
        return;
      }
      var p = document.createElement('p');
      p.classList.add('level-item');
      p.classList.add('has-text-centered');
      var span = document.createElement('span');
      span.style.color = player.color;
      span.innerHTML = '●';
      p.appendChild(span);
      p.innerHTML += '&nbsp;' + player.name;
      playerListFooter.appendChild(p);
    });
  }

  // Set up a new PeerJS object
  const peer = new Peer();
  // Get an ID for peer discovery
  peer.on('open', id => {
    console.log('My peer ID is: ' + id);
    window.playerId = id;
    // Connect to server
    console.log('Connecting to server');
    var conn = peer.connect(serverId, {
      metadata: {
        playerName: playerName,
        playerColor: playerColor,
        serverPw: serverPw
      }
    });
    // Set handler for receiving messages
    conn.on('data', data => {
      handleData(data);
    });
  });

  // Handle incoming data
  function handleData(data) {
    console.log('received data from server');
    console.log(data);
    if (data.mType == 'gameColumns') {
      fillGameTable(data.payload);
    }
    if (data.mType == 'playerList') {
      updatePlayerList(data.payload);
    }
  }

  </script>

  <!-- # # # # # # # # # # # # # # # # # # # # # # # # # # # -->

  <script>

  /* - - - mobile burger menu toggle - - - */
  document.addEventListener('DOMContentLoaded', () => {
    // Get all "navbar-burger" elements
    const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
    // Add a click event on each of them
    $navbarBurgers.forEach( el => {
      el.addEventListener('click', () => {
        // Get the target from the "data-target" attribute
        const target = el.dataset.target;
        const $target = document.getElementById(target);
        // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
        el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  });
  /* /- - - mobile burger menu toggle - - - */

  </script>
  </body>
</html>
