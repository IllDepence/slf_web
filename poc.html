<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Start-Land-Fluss Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
    <style>
      /* Your CSS styles go here */
    </style>
  </head>
  <body>
    <h1>Start-Land-Fluss Game</h1>
    <p>Player ID: <span id="player-id"></span></p>
    <p>Player Name: <span id="player-name"></span></p>
    <form id="player-name-form">
      <label for="player-name-input">Enter your player name:</label>
      <input type="text" id="player-name-input" name="player-name-input" />
      <button type="submit">Submit</button>
    </form>
    <hr />
    <form id="connect-form">
      <label for="peer-id">Enter the PeerJS ID of another player:</label>
      <input type="text" id="peer-id" name="peer-id" />
      <button type="submit">Connect</button>
    </form>
    <ul id="player-list"></ul>
    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
    <script>
    // Set up a new PeerJS object
    const peer = new Peer();
    // Get an ID for peer discovery
    peer.on('open', id => {
      console.log('My peer ID is: ' + id);
      const playerIdDiv = document.getElementById('player-id');
      playerIdDiv.textContent = id;
    });

    // Handle player name form submission
    const playerNameForm = document.getElementById('player-name-form');
    const playerNameInput = document.getElementById('player-name-input');
    playerNameForm.addEventListener('submit', event => {
      event.preventDefault();
      const playerName = playerNameInput.value.trim();
      if (playerName) {
        const playerId = peer.id;
        playerNameForm.style.display = 'none';
        const playerNameDiv = document.getElementById('player-name');
        playerNameDiv.textContent = playerName;
        // Save the player name and ID to a global object
        window.player = { name: playerName, id: playerId };
      }
    });

    window.peers = {}

    // Send player name
    function sendPlayerName(conn) {
        console.log('sending name');
        conn.send(
          {
            mtype: 'sendName',
            payload: {
              name: window.player.name,
              firstTime: true
            }
          }
        );
    }

    // Handle incoming connections
    function handleData(peerId, data) {
      console.log('received data from peer ID' + peerId + ':');
      console.log(data);
      if (data.mtype == 'sendName') {
        // Peer just told us their name
        const peerName = data.payload.name;
        // Store and display name
        window.peers[peerId].peerName = peerName;
        const playerList = document.getElementById('player-list');
        const listItem = document.createElement('li');
        listItem.textContent = `Player ${peerName} has joined the game`;
        playerList.appendChild(listItem);
        // If they don't already know our name, tell them
        if (data.payload.firstTime) {
          console.log('sending name back');
          window.peers[peerId].connection.send(
            {
              mtype: 'sendName',
              payload: {
                name: window.player.name,
                firstTime: false
              }
            }
          );
        }
      }
    }

    // Connect to peers
    const connectForm = document.getElementById('connect-form');
    const peerIdInput = document.getElementById('peer-id');
    connectForm.addEventListener('submit', event => {
      event.preventDefault();
      const peerId = peerIdInput.value.trim();
      if (peerId) {
        if (peerId in window.peers) {
          console.log('already connected to this peer');
        }
        else {
          // Connect
          console.log('connecting to peer');
          var conn = peer.connect(peerId, {
            metadata: { msg: 'foobar' }
          });

          // Add peer to global dictionary of peers
          window.peers[peerId] = {
            connection: conn
          };
          // Set handler for receiving messages
          conn.on('data', data => {
            handleData(conn.peer, data);
          });
        }
      }
    });

    // Handle incoming new connections
    peer.on('connection', conn => {
      const peerId = conn.peer;
      console.log('incoming connection form  peer');
      console.log('msg: ' + conn.metadata.msg);

      // Check if we already have a connection established to this peer
      if (peerId in window.peers) {
        console.log('already connected to this peer');
      }
      else {
        // If itâ€™s a new connection
        console.log('adding new connection');
        // Add connection to global list of peer connections
        window.peers[peerId] = {
          connection: conn
        }
        // Set handler for receiving messages
        conn.on('data', data => {
          handleData(conn.peer, data);
        });
        // Send own player name to peer
        setTimeout(() => {
          sendPlayerName(conn);
        }, 500);
      }
    });

    // TODO:
    // - define function to handle receiving data
    // - send player name after establishing connection
    // - ...

    /*

      // Send the player's name to the connected peer
      const player = window.player;
      const playerName = player.playerName;
      conn.send(playerName);

      // Set a property to store the connected player's name
      conn.playerName = '';

      conn.on('data', data => {
        if (!conn.playerName) {
          // Update the player's name in the list
          conn.playerName = data;
          listItem.textContent = `Player ${conn.playerName} (${peerId}) has joined the game`;
        } else {
          // Process the received game data
          console.log(`Received data from peer ${peerId}: ${data}`);
        }
      });

    */
    </script>
  </body>
</html>

